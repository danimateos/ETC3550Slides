---
title: "Time Series & Forecasting"
author: "Ch1. Getting started"
date: \today
toc: true
titlepage: titlepage-ie.jpg
output:
  binb::monash:
    fig_width: 7
    fig_height: 3.5
    includes:
      in_header: header.tex
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dev.args = list(pointsize = 11)
)
options(
  digits = 3,
  width = 60,
  ggplot2.continuous.colour="viridis",
  ggplot2.continuous.fill = "viridis",
  ggplot2.discrete.colour = c("#D55E00", "#0072B2","#009E73", "#CC79A7", "#E69F00", "#56B4E9", "#F0E442"),
  ggplot2.discrete.fill = c("#D55E00", "#0072B2","#009E73", "#CC79A7", "#E69F00", "#56B4E9", "#F0E442")
)
library(fpp3)
library(patchwork)
library(gganimate)
```

```{r datasets, include=FALSE}
austa <- readr::read_csv("http://OTexts.com/fpp3/extrafiles/austa.csv") %>%
  as_tsibble(index = Year)
melsyd <- tsibbledata::ansett %>%
  filter(Airports == "MEL-SYD")
```

# What can we forecast?

## Forecasting is difficult

\fullheight{hopecasts2}

## Forecasting is difficult

\fullwidth{bad_forecasts}

## What can we forecast?

\fullwidth{nasdaq-stock-market}

## What can we forecast?

\fullwidth{Forex2}

## What can we forecast?

\fullwidth{pills}

## What can we forecast?

\fullwidth{elecwires2}

## What can we forecast?

\fullheight{AusBOM}


## What can we forecast?

\fullwidth{ts22015}

## What can we forecast?

\fullheight{comet}


## Which is easiest to forecast?

 1. daily electricity demand in 3 days time
 2. timing of next Halley's comet appearance
 3. time of sunrise this day next year
 4. Google stock price tomorrow
 5. Google stock price in 6 months time
 6. maximum temperature tomorrow
 7. exchange rate of \$US/AUS next week
 8. total sales of drugs in pharmacies next month

\only<2>{\begin{alertblock}{}\Large\bfseries\sffamily
https://pollev.com/danielmateos767
\end{alertblock}}

\only<3>{\begin{block}{}\begin{itemize}\tightlist
 \item how do we measure ``easiest''?
 \item what makes something easy/difficult to forecast?
 \end{itemize}\end{block}}

 \vspace*{10cm}

## Factors affecting forecastability

Something is easier to forecast if:

 1. we have a good understanding of the factors that contribute to it
 2. there is lots of data available;
 3. the future is somewhat similar to the past
 4. the forecasts cannot affect the thing we are trying to forecast.

## Improving forecasts

\fullheight{ncep-skill}

# Time series data

## Time series data

  - Four-yearly Olympic winning times
  - Annual Google profits
  - Quarterly Australian beer production
  - Monthly rainfall
  - Weekly retail sales
  - Daily IBM stock prices
  - Hourly electricity demand
  - 5-minute freeway traffic counts
  - Time-stamped stock transaction data

## Australian quarterly beer production

```{r, echo=FALSE, fig.height=5.5, fig.width=8}
aus_production %>% autoplot(Beer)
```

\only<2>{\begin{textblock}{6}(6.4,5.1)
\begin{alertblock}{}
Forecasting is estimating how the sequence of observations will continue into the future.
\end{alertblock}
\end{textblock}}

\vspace*{10cm}

## Australian quarterly beer production

```{r, eval=TRUE, include=TRUE, echo=FALSE, fig.show='animate', interval=1/10, message=FALSE, fig.height=5, fig.width=8, aniopts='controls,buttonsize=0.3cm,width=11.5cm', cache=TRUE}
fc <- aus_production %>%
  model(ETS(Beer)) %>%
  forecast()
p <- autoplot(fc, aus_production)
# More automatic approach to identifying plot limits
p_built <- ggplot_build(p)
ylim <- p_built$layout$panel_scales_y[[1]]$range$range
xlim <- p_built$layout$panel_scales_x[[1]]$range$range
p +
  view_step_manual(
    xmin = c(xlim[1],0.1*xlim[1]+0.9*xlim[2]),
    xmax = rep(xlim[2], 2),
    ymin = rep(ylim[1], 2),
    ymax = rep(ylim[2], 2), wrap=FALSE)
```

\vspace*{10cm}


# The statistical forecasting perspective

## Sample futures

```{r austa1, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.width=9, fig.height=6}
fit <- austa %>% model(ETS(Visitors))
```

```{r austa1a, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.width=9, fig.height=6}
sim <- fit %>% generate(h = 10, times = 10) %>%
  mutate(
    replicate = factor(.rep, levels = 1:10, labels = paste("Future", 1:10))
  )
p1 <- ggplot(austa, aes(x = Year)) +
  geom_line(aes(y = Visitors, colour = "Data")) +
  geom_line(aes(y = .sim, colour = replicate), data = sim) +
  labs(
    y = "Millions of visitors",
    title = "Total international visitors to Australia"
  ) +
  scale_colour_manual(values = c("#000000", rainbow(10)),
                      breaks = c("Data", paste("Future", 1:10)),
                      name = " ") +
  ylim(0.8,10)
p2 <- fit %>%
  forecast(h = 10) %>%
  autoplot(austa) +
  labs(
    y = "Millions of visitors",
    title = "Forecasts of total international visitors to Australia"
  ) +
  ylim(0.8,10)
aligned_plots <- align_patches(p1,p2)
aligned_plots[[1]]
```

## Forecast intervals

```{r austa2, dependson='austa1a', echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.width=9, fig.height=6}
aligned_plots[[2]]
```


## Statistical forecasting

\fontsize{14}{16}\sf

- Thing to be forecast: a random variable, $y_t$.
- Forecast distribution: If ${\cal I}$ is all observations, then $y_{t} |{\cal I}$ means "the random variable $y_{t}$ given what we know in ${\cal I}$.
- The "point forecast" is the mean (or median) of $y_{t} |{\cal I}$
- The "forecast variance" is $\text{var}[y_{t} |{\cal I}]$
- A prediction interval or "interval forecast" is a range of values of $y_t$ with high probability.
- With time series, ${y}_{t|t-1} = y_t | \{y_1,y_2,\dots,y_{t-1}\}$.
- $\hat{y}_{T+h|T} =\text{E}[y_{T+h} | y_1,\dots,y_T]$ (an $h$-step forecast taking account of all observations up to time $T$).


