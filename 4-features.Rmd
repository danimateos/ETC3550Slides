---
title: "Time Series & Forecasting"
author: "Ch4. Time series features"
date: \today
toc: true
titlepage: titlepage-ie.jpg
output:
  binb::monash:
    fig_width: 7
    fig_height: 3.5
    includes:
      in_header: header.tex
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dev.args = list(pointsize = 11)
)
options(
  digits = 3,
  width = 60,
  ggplot2.continuous.colour="viridis",
  ggplot2.continuous.fill = "viridis",
  ggplot2.discrete.colour = c("#D55E00", "#0072B2","#009E73", "#CC79A7", "#E69F00", "#56B4E9", "#F0E442"),
  ggplot2.discrete.fill = c("#D55E00", "#0072B2","#009E73", "#CC79A7", "#E69F00", "#56B4E9", "#F0E442")
)
library(fpp3)
library(purrr)
library(transformr) # Just to get it on renv
library(gganimate)
library(latex2exp)
```


# Basic stats

## The `features()` function

smean, std, min, max... Any function that computes a scalar value from a vector.

```{r}
hh_budget %>% 
  features(Savings, list(avg_savings = mean, std_savings = sd), na.rm=TRUE)
```

## Using the `quantile` function 


```{r}
hh_budget %>% 
  features(Savings, quantile)
```

# Autocorrelation

## Autocorrelation functions

Remember:

https://twitter.com/allison_horst/status/1361545021980217345

## US retail trade employment
\fontsize{11}{12}\sf

```{r}
retail <- us_employment %>%
  filter(Title == "Retail Trade", year(Month) >= 1980) %>% 
  mutate(diff = difference(Employed))

retail %>% autoplot(diff)
```

## US retail trade employment
\fontsize{11}{12}\sf

```{r}
retail %>%
  ACF(diff, lag_max = 48) %>%
  autoplot()
```

## Google stock price
\fontsize{12}{14}\sf

```{r google-2015}
google_2015 <- gafa_stock %>%
  filter(Symbol == "GOOG", year(Date) == 2015) %>%
  select(Date, Close)
google_2015
```

## Google stock price

```{r}
google_2015 %>% autoplot(Close)
```


## Google stock price
\fontsize{11}{13}\sf

```{r}
google_2015 <- google_2015 %>%
  mutate(trading_day = row_number()) %>%
  update_tsibble(index = trading_day, regular = TRUE)  %>%
  ACF(Close, lag_max = 100) %>%
  autoplot()
```

## Google stock price

```{r}
google_2015
```


## `feat_acf()` function.
\fontsize{10}{11}\sf

The feat_acf() function computes a selection of the autocorrelations discussed here. It will return the following features:

* The first autocorrelation coefficient from the original data;
* The sum of squares of the first ten autocorrelation coefficients from the original data;
* The first autocorrelation coefficient from the differenced data;
* The sum of squares of the first ten autocorrelation coefficients from the differenced data;
* The first autocorrelation coefficient from the twice differenced data;
* The sum of squares of the first ten autocorrelation coefficients from the twice differenced data;
* For seasonal data, the autocorrelation coefficient at the first seasonal lag is also returned.

## `feat_acf()` function.


```{r}
tourism %>% 
  features(Trips, feat_acf)
```

# STL Features

## STL Decomposition

Remember:

```{r usretail}
us_retail_employment <- us_employment %>%
  filter(year(Month) >= 1990, Title == "Retail Trade") %>%
  select(-Series_ID)
us_retail_employment
```

```{r stlwindow9, echo=TRUE, warning=FALSE, fig.width=8, fig.height=4}
us_retail_employment %>%
  model(STL(Employed ~ season(window=9), robust=TRUE)) %>%
  components() %>% autoplot() +
    labs(title = "STL decomposition: US retail employment")
```

## Creating features with STL


After decomposing, we can get an idea of the relative strength of trends and seasonal effects with the `feat_stl()` function. 


$$F_T = max \left(0, 1-\frac{Var(R_t)}{Var(T_t + R_t)}\right)$$ 


$$F_S = max \left(0, 1-\frac{Var(R_t)}{Var(S_t + R_t)}\right)$$ 

## Finding heavily trended / seasonal series with STL features
\fontsize{9}{10}\sf

```{r out.width="30%"}
tourism %>%
  features(Trips, feat_stl) %>%
  ggplot(aes(x = trend_strength, y = seasonal_strength_year,
             col = Purpose)) +
  geom_point() +
  facet_wrap(vars(State))
```


## The most seasonal series in the Australian tourism data

\fontsize{9}{10}\sf

```{r}
tourism %>%
  features(Trips, feat_stl) %>%
  filter(
    seasonal_strength_year == max(seasonal_strength_year)
  ) %>%
  left_join(tourism, by = c("State", "Region", "Purpose")) %>%
  ggplot(aes(x = Quarter, y = Trips)) +
  geom_line() +
  facet_grid(vars(State, Region, Purpose))
```

## Your turn

Explore the `PBS` data with the tool you just learned.

* Which is the most heavily trended series of all?
* Which is the most heavily seasonal series of all?


## Other features from the `feat_stl()` function

* `seasonal_peak_year`
* `seasonal_trough_year`
* `spikiness`
* `linearity`
* `curvature`
* `stl_e_acf1`
* `stl_e_acf10`

# Other features

## Other features

Apart from autocorrelation features and STL features, there are many more functions that we can apply to time series to get and idea of the behavior of the series:

* `coef_hurst`: "long memory".
* `feat_spectral`: "forecastability".
* `box_pierce`: white noise similarity.
* `ljung_box`: white noise similarity.
* `unitroot_kpss`: stationarity
* `unitroot_pp`:
* `unitroot_ndiffs`
* `unitroot_nsdiffs`
* `var_tiled_mean`
* `var_tiled_var`
* `shift_level_max`
* `shift_level_index`
* `shift_var_max`
* `shift_var_index`
* `shift_kl_max`
* `shift_kl_index`
* `n_crossing_points`
* `longest_flat_spot`
* `stat_arch_lm`
* `guerrero`

# Exploring Australian tourism data

## Feature sets

You can compute many features in a single line like so:

```{r}
tourism_features <- tourism %>%
  features(Trips, feature_set(pkgs = "feasts"))
```

We can then use this to explore the original dataset and find, for example, the most seasonal time series in it.
